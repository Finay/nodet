<!doctype html>
<html>
    <head>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bgdark: #ede8d7;
                --bglight: #fcf6e5;
                --borderdark: #96a0a1;
                --borderlight: #e2e1de;
                --blue: #4689cc;
                --green: #8d9b31;
                --red: #cb4239;
                --turq: #519f98;
                --text: #6a7b82;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                overflow: hidden;
                font-family: "Inter", sans-serif;
            }

            #container {
                display: flex;
            }

            #graphview {
                width: 50vw;
                height: 100vh;
                background-color: var(--bglight);
                border-right: var(--borderdark) 1px solid;
            }

            #textviews {
                width: 50vw;
                height: 100vh;
            }

            #editorview {
                width: 100%;
                height: 50%;
                background-color: var(--bglight);
                border-left: var(--borderdark) 1px solid;
                border-bottom: var(--borderdark) 1px solid;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            #editorbar {
                height: calc(8%);
                width: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 5px;
            }

            #editorpath {
                color: var(--text);
                font-size: 13px;
            }

            #editortitlebox {
                height: 12%;
                width: 100%;
                display: flex;
                align-items: center;
            }

            #editortitle {
                margin-left: 20px;
                margin-right: 20px;
                width: 100%;
                font-size: 4vh;
                color: var(--turq);
            }

            #editortitle:focus-visible,
            #editorcontent:focus-visible {
                outline: var(--borderlight) 2px solid;
            }

            #editorcontentbox {
                height: 80%;
                width: 100%;
            }

            #editorcontent {
                display: block;
                height: calc(100% - 20px);
                width: calc(100% - 30px);
                margin-top: 10px;
                margin-left: 20px;
                margin-right: 10px;
                margin-bottom: 10px;
                overflow: scroll;
                color: var(--text);
            }
            .linkertext {
                background-color: var(--bgdark);
                border-radius: 2px;
                padding: 0 2px;
                font-weight: bold;
            }
            #navigatorview {
                width: 100%;
                height: 50%;
                background-color: var(--bglight);
                border-left: var(--borderdark) 1px solid;
                border-top: var(--borderdark) 1px solid;
            }
        </style>
    </head>

    <body>
        <div id="container">
            <div id="graphview"></div>
            <div id="textviews">
                <div id="editorview">
                    <div id="editorbar">
                        <div id="editorpath">path > path</div>
                    </div>
                    <div id="editortitlebox">
                        <div id="editortitle" contenteditable="true">TITLE</div>
                    </div>
                    <div id="editorcontentbox">
                        <div id="editorcontent" contenteditable="true">
                            Lorem Ipsum
                            <span class="linkertext" onclick="editContent()"
                                >hello</span
                            >
                            asdf
                        </div>
                    </div>
                </div>
                <div id="navigatorview"></div>
            </div>
        </div>
        <script>
            function editContent() {
                const ec = document.getElementById("editorcontent");
                const range = document.createRange();
                const selection = window.getSelection();
                const savepoint = selection.focusNode;

                ec.textContent = "Lorem Ipsum";

                range.setStart(savepoint, 0);
                range.collapse(true);

                selection.removeAllRanges();
                selection.addRange(range);
            }
        </script>
        <script type="module">
            import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

            // Globals
            let simulatednodes = [
                {
                    id: "cf0b19f251f438",
                    title: "Idea 1",
                    color: 0,
                    content: "Lorem",
                    time: Date.now(),
                }, // Math.random().toString(16).slice(2)
                {
                    id: "1c0e0c501d58f8",
                    title: "Idea 2",
                    color: 1,
                    content: "Ipsum",
                    time: Date.now(),
                },
            ];
            let simulatedlinks = [
                { source: "cf0b19f251f438", target: "1c0e0c501d58f8" },
            ];

            let primarynodeid = "cf0b19f251f438";
            let secondarynodeid = "1c0e0c501d58f8";

            const dimensionscale = 0.5;

            const chartwidth = graphview.offsetWidth;
            const chartheight = graphview.offsetHeight;

            const simulation = d3
                .forceSimulation(simulatednodes)
                .force(
                    "link",
                    d3
                        .forceLink(simulatedlinks)
                        .id((link) => link.id)
                        .strength((link) => 1),
                )
                .force("charge", d3.forceManyBody());

            const svg = d3
                .create("svg")
                .attr("width", chartwidth)
                .attr("height", chartheight)
                .attr("viewBox", [
                    (-chartwidth / 2) * dimensionscale,
                    (-chartheight / 2) * dimensionscale,
                    chartwidth * dimensionscale,
                    chartheight * dimensionscale,
                ])
                .attr("style", "max-width: 100%; height: auto;")
                .call(
                    d3
                        .zoom()
                        .extent([
                            [0, 0],
                            [chartwidth, chartheight],
                        ])
                        .scaleExtent([1, 8])
                        .on("zoom", ({ transform }) => {
                            graphlinks.attr("transform", transform);
                            graphnodes.attr("transform", transform);
                        }),
                );

            let graphlinks = svg
                .append("g")
                .selectAll("line")
                .data(simulatedlinks)
                .join("line");

            let graphnodes = svg
                .append("g")
                .selectAll("circle")
                .data(simulatednodes, (node) => node.id)
                .join("circle");

            simulation.on("tick", () => {
                graphlinks
                    .attr("x1", (link) => link.source.x)
                    .attr("y1", (link) => link.source.y)
                    .attr("x2", (link) => link.target.x)
                    .attr("y2", (link) => link.target.y);

                graphnodes
                    .attr("cx", (node) => node.x)
                    .attr("cy", (node) => node.y);
            });

            function updatenodestructure(nodes, links) {
                simulation.nodes(nodes);
                simulation.force("link").links(links);
                simulation.alpha(1).restart();

                graphnodes = graphnodes
                    .data(nodes, (node) => node.id)
                    .join((enter) => enter.append("circle"));

                graphlinks = graphlinks
                    .data(
                        links,
                        (link) => `${link.source.id}\t${link.target.id}`,
                    )
                    .join("line");
            }

            function nodestructureupdated() {
                graphnodes.call(
                    d3
                        .drag()
                        .on("start", (event) => {
                            if (!event.active)
                                simulation.alphaTarget(0.3).restart();
                            event.subject.fx = event.subject.x;
                            event.subject.fy = event.subject.y;
                        })
                        .on("drag", (event) => {
                            event.subject.fx = event.x;
                            event.subject.fy = event.y;
                        })
                        .on("end", (event) => {
                            if (!event.active) simulation.alphaTarget(0);
                            event.subject.fx = null;
                            event.subject.fy = null;
                        }),
                );
            }

            function nodestrokecolor(node) {
                return node.id == primarynodeid ? "#BEB4B0" : "#fcf6e5";
            }

            const nodecolorscale = ["#4689cc", "#8d9b31", "#cb4239"];

            function nodestrokeopacity(node) {
                return node.id == primarynodeid ? 1 : 1;
            }

            function isselectedlink(link) {
                return (
                    (primarynodeid == link.source.id &&
                        secondarynodeid == link.target.id) ||
                    (primarynodeid == link.target.id &&
                        secondarynodeid == link.source.id)
                );
            }

            function islinkwithprimary(link) {
                return (
                    primarynodeid == link.source.id ||
                    primarynodeid == link.target.id
                );
            }

            function linkcolor(link) {
                return isselectedlink(link) ? "#000" : "#999";
            }

            function linkstrokewidth(link) {
                return islinkwithprimary(link) ? 2 : 1;
            }

            function nodestylingupdated() {
                graphnodes
                    .attr("r", 5)
                    .attr("stroke", (node) => nodestrokecolor(node))
                    .attr("stroke-opacity", (node) => nodestrokeopacity(node))
                    .attr("stroke-width", 1.5)
                    .attr("fill", (node) => nodecolorscale[node.color]);
                graphlinks
                    .attr("stroke", (link) => linkcolor(link))
                    .attr("stroke-opacity", 0.6)
                    .attr("stroke-width", (link) => linkstrokewidth(link));
            }

            function getneighbors(nodeid) {
                return graphlinks.data().reduce((neighbors, link) => {
                    if (link.target.id === nodeid) {
                        neighbors.push(link.source.id);
                    } else if (link.source.id === nodeid) {
                        neighbors.push(link.target.id);
                    }
                    return neighbors;
                }, []);
            }

            function getnextneighborid(
                step = 1,
                targetnodeid = primarynodeid,
                targetneighborid = secondarynodeid,
            ) {
                const neighbornodeids = getneighbors(targetnodeid);
                if (neighbornodeids.length == 0) {
                    alert("Neighbor search returned empty.");
                }
                const index = neighbornodeids.indexOf(targetneighborid);
                if (index == -1) {
                    return neighbornodeids[0];
                } else {
                    return neighbornodeids[
                        (index + step + neighbornodeids.length) %
                            neighbornodeids.length
                    ];
                }
            }

            // graphwalk
            addEventListener("keydown", (event) => {
                if (event.code == "KeyD") {
                    secondarynodeid = getnextneighborid();
                } else if (event.code == "KeyA") {
                    secondarynodeid = getnextneighborid(-1);
                } else if (event.code == "KeyW") {
                    const temp = primarynodeid;
                    primarynodeid = secondarynodeid;
                    secondarynodeid = temp;

                    secondarynodeid = getnextneighborid();
                } else if (event.code == "KeyS") {
                    secondarynodeid = getnextneighborid(-1);

                    const temp = primarynodeid;
                    primarynodeid = secondarynodeid;
                    secondarynodeid = temp;
                } else if (event.code == "KeyI") {
                    let newnodeid = Math.random().toString(16).slice(2);
                    let oldnodesdata = graphnodes.data();
                    oldnodesdata.push({
                        id: newnodeid,
                        title: "",
                        color: "0",
                        content: "",
                        time: Date.now(),
                    });
                    let oldlinksdata = graphlinks.data();
                    oldlinksdata.push({
                        source: primarynodeid,
                        target: newnodeid,
                    });
                    secondarynodeid = primarynodeid;
                    primarynodeid = newnodeid;

                    updatenodestructure(oldnodesdata, oldlinksdata);
                    nodestructureupdated();
                } else if (event.key == "1") {
                    download(
                        JSON.stringify({
                            nodes: graphnodes.data(),
                            links: graphlinks.data(),
                        }),
                        "json.txt",
                        "text/plain",
                    );
                } else {
                    return;
                }

                nodestylingupdated();
            });

            // Download & Upload
            function download(content, fileName, contentType) {
                var a = document.createElement("a");
                var file = new Blob([content], { type: contentType });
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
            }

            addEventListener("dragover", function (event) {
                event.preventDefault();
            });

            addEventListener("drop", (ev) => {
                ev.preventDefault();
                async function getDrop() {
                    const text = await [...ev.dataTransfer.items][0]
                        .getAsFile()
                        .text();
                    console.log(JSON.parse(text));
                    const { nodes, links } = JSON.parse(text);
                    updatenodestructure(nodes, links);
                    nodestructureupdated();
                    nodestylingupdated();
                }
                getDrop();
            });

            // finalize initial graph and add to view
            nodestructureupdated();
            nodestylingupdated();
            graphview.append(svg.node());
        </script>
    </body>
</html>
