<!doctype html>
<html>
    <head>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bgdark: #ede8d7;
                --bglight: #fcf6e5;
                --borderdark: #96a0a1;
                --borderlight: #e2e1de;
                --blue: #4689cc;
                --green: #8d9b31;
                --red: #cb4239;
                --turq: #519f98;
                --text: #6a7b82;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                overflow: hidden;
                font-family: "Inter", sans-serif;
            }

            #container {
                display: flex;
            }

            #graphview {
                width: 50vw;
                height: 100vh;
                background-color: var(--bglight);
                border-right: var(--borderdark) 1px solid;
            }

            #textviews {
                width: 50vw;
                height: 100vh;
            }

            #editorview {
                width: 100%;
                height: 50%;
                background-color: var(--bglight);
                border-left: var(--borderdark) 1px solid;
                border-bottom: var(--borderdark) 1px solid;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            #editorbar {
                height: calc(8%);
                width: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 5px;
            }

            #editorpath {
                color: var(--text);
                font-size: 13px;
            }

            #editortitlebox {
                height: 12%;
                width: 100%;
                display: flex;
                align-items: center;
            }

            #editordot {
                height: 40%;
                aspect-ratio: 1;
                background-color: var(--green);
                margin-left: 20px;
                border-radius: 50%;
                outline: #64625D 0.5vh solid;
                cursor: pointer;
            }

            #editortitle {
                margin-left: 10px;
                margin-right: 20px;
                width: 100%;
                font-size: 4vh;
                color: var(--turq);
            }

            #editortrash {
                height: 40%;
                aspect-ratio: 1;
                margin-right: 20px;
                color: var(--red);
                cursor: pointer;
            }

            #editortitle:focus-visible,
            #editorcontent:focus-visible {
                outline: var(--borderlight) 2px solid;
            }

            #editorcontentbox {
                height: 80%;
                width: 100%;
            }
            #editorlinkcontainer {
                height: 25px;
                width: calc(100% - 50px);
                margin-top: 10px;
                margin-left: 20px;
                margin-right: 10px;
                margin-bottom: 10px;
                display: flex;
                justify-content: left;
                align-items: center;
            }
            #editorlinkadd {
                color: var(--borderdark);
                margin: 0 4px;
                font-size: 20px;
                border-radius: 4px;
                background: var(--bgdark);
                height: 20px;
                margin-bottom: 3px;
                cursor: pointer;
            }
            #editorlinkadd:hover {
                background: var(--borderdark);
            }
            #editorlinkbox {
                height: 25px;
                width: calc(100% - 30px);
                overflow-x: scroll;
                display: block;
                white-space: nowrap;
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
            #editorlinkbox::-webkit-scrollbar {
              display: none;
            }
            .editorlink {
                color: var(--text);
                border: 2px var(--blue) solid;
                border-radius: 6px;
                font-size: 13px;
                padding: 0 5px 0 5px ;
                width: max-content;
                display: inline;
                margin-right: 2px;
            }
            .editorlink[data-relation='sim'] {
                border: 2px var(--green) solid;
            }
            .editorlink[data-relation='vis'] {
                border: 2px var(--blue) solid;
            }
            .editorlink:hover {
                padding: 0 0 0 5px;
            }
            .editorlinkcycle {
                display: none;
                border-left: 2px solid var(--bgdark);
                padding: 0 2px;
                cursor: pointer;
                color: var(--green);
            }
            .editorlinkcycle:hover {
                background: var(--green);
            }
            .editorlink:hover .editorlinkcycle, .editorlink:hover .editorlinkdelete{
                display: inline;
            }
            .editorlinkdelete {
                display: none;
                border-left: 2px solid var(--bgdark);
                padding: 0 3px;
                cursor: pointer;
                color: var(--red);
                border-top-right-radius: 4px;
                border-bottom-right-radius: 4px;
            }
            .editorlinkdelete:hover {
                background: var(--red);
            }

            #editorcontent {
                display: block;
                height: calc(100% - 45px);
                width: calc(100% - 30px);
                margin-top: 10px;
                margin-left: 20px;
                margin-right: 10px;
                margin-bottom: 10px;
                overflow-y: scroll;
                overflow-x: hidden;
                color: var(--text);
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
            #editorcontent::-webkit-scrollbar {
              display: none;
            }
            #navigatorview {
                width: 100%;
                height: 50%;
                background-color: var(--bglight);
                border-left: var(--borderdark) 1px solid;
                border-top: var(--borderdark) 1px solid;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            #navresults {
                overflow-y: scroll;
                overflow-x: hidden;
                display: block;
                color: var(--text);
                margin-left: 20px;
                margin-right: 15px;
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
            #navresults::-webkit-scrollbar {
              display: none;
            }
            #navresults tbody {
                width: 100%;
                display: block;
            }
            #navresults tr {
                height: 25px;
            }
            #navsearchbox {
                border-top: 2px solid var(--borderlight);
                width: 100%;
                height: 60px;
                position: relative;
                bottom: 0;
                display: flex;
            }
            #navsearchbar {
                height: 30px;
                line-height: 30px;
                padding-left: 5px;
                border-radius: 6px;
                border: solid 2px var(--borderdark);
                width: calc(100% - 50px);
                margin: 13px 8px 13px 12px;
                color: var(--text);
                outline: none !important;
                overflow: hidden;
                white-space: no-wrap;
            }
            #graphfiltertoggle {
                height: 30px;
                width: 30px;
                margin: 15px 20px 15px 16px;
            }
            #graphfiltertoggle svg#iconinvisible {
                display: none;
            }
            .resultdot {
                width: 20px;
            }
            .dot {
              height: 12px;
              width: 12px;
              background-color: var(--blue);
              border-radius: 50%;
              display: inline-block;
            }
            .selected .dot {
                outline: 2.5px #64625D solid;
            }
            .secondary .dot {
                outline: 2.5px #64625D dashed;
            }
            .resulttitle {
                width: 80%;
                white-space: nowrap;
                overflow: scroll;
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
            .resulttitle::-webkit-scrollbar {
              display: none;
            }
            }
            .resultlink {
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                margin: 0 0 0 10px;
            }
            .selected .resultlink {
                pointer-events: none;
                visibility: hidden;
            }
            .resultlink .linkicon path {
                fill: var(--red);
            }
            .rltarget .linkicon path {
                fill: var(--green);
            }
            .rlsource .linkicon path {
                fill: var(--blue);
            }
            #graphfiltertoggle {
                cursor: pointer;
            }
        </style>
    </head>

    <body>
        <div id="container">
            <div id="graphview"></div>
            <div id="textviews">
                <div id="editorview">
                    <div id="editortitlebox">
                        <div id="editordot"></div>
                        <div id="editortitle" contenteditable="true"></div>
                        <div id="editortrash">&#10006;</div>
                    </div>
                    <div id="editorcontentbox">
                        <div id="editorlinkcontainer">
                            <div id="editorlinkadd">
                                <svg width="20px" height="20px" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
<defs><style>.cls-1{fill:none;stroke:#96a0a1;stroke-linecap:round;stroke-linejoin:round;stroke-width:2px;}</style></defs>
                                <title/>

                                <g id="plus">

                                <line class="cls-1" x1="16" x2="16" y1="7" y2="25"/>

                                <line class="cls-1" x1="7" x2="25" y1="16" y2="16"/>

                                </g>

                                </svg>
                            </div>
                            <div id="editorlinkbox">
                            </div>
                        </div>
                        <div id="editorcontent" contenteditable="true">
                        </div>
                    </div>
                </div>
                <div id="navigatorview">
                    <table id="navresults">
                     <tr class="navresultsrow selected">
                        <td class="resultdot"><span class="dot"></span></td>
                        <td class="resulttitle">Untitled  asf asdf sa fasd fasdf asdf  </td>
                        <td class="resultdate">0000-00-00</td>
                        <td class="resultlink">
                           <svg width="19px" height="19px" class="linkicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M451.5 160C434.9 160 418.8 164.5 404.7 172.7C388.9 156.7 370.5 143.3 350.2 133.2C378.4 109.2 414.3 96 451.5 96C537.9 96 608 166 608 252.5C608 294 591.5 333.8 562.2 363.1L491.1 434.2C461.8 463.5 422 480 380.5 480C294.1 480 224 410 224 323.5C224 322 224 320.5 224.1 319C224.6 301.3 239.3 287.4 257 287.9C274.7 288.4 288.6 303.1 288.1 320.8C288.1 321.7 288.1 322.6 288.1 323.4C288.1 374.5 329.5 415.9 380.6 415.9C405.1 415.9 428.6 406.2 446 388.8L517.1 317.7C534.4 300.4 544.2 276.8 544.2 252.3C544.2 201.2 502.8 159.8 451.7 159.8zM307.2 237.3C305.3 236.5 303.4 235.4 301.7 234.2C289.1 227.7 274.7 224 259.6 224C235.1 224 211.6 233.7 194.2 251.1L123.1 322.2C105.8 339.5 96 363.1 96 387.6C96 438.7 137.4 480.1 188.5 480.1C205 480.1 221.1 475.7 235.2 467.5C251 483.5 269.4 496.9 289.8 507C261.6 530.9 225.8 544.2 188.5 544.2C102.1 544.2 32 474.2 32 387.7C32 346.2 48.5 306.4 77.8 277.1L148.9 206C178.2 176.7 218 160.2 259.5 160.2C346.1 160.2 416 230.8 416 317.1C416 318.4 416 319.7 416 321C415.6 338.7 400.9 352.6 383.2 352.2C365.5 351.8 351.6 337.1 352 319.4C352 318.6 352 317.9 352 317.1C352 283.4 334 253.8 307.2 237.5z"/></svg>
                        </td>
                     </tr>
                   </table>
                   <div id="navsearchbox">
                       <div id="navsearchbar" contenteditable="true">

                       </div>
                       <div id="graphfiltertoggle">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                               <!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                               <path fill="#96a0a1" d="M320 144C254.8 144 201.2 173.6 160.1 211.7C121.6 247.5 95 290 81.4 320C95 350 121.6 392.5 160.1 428.3C201.2 466.4 254.8 496 320 496C385.2 496 438.8 466.4 479.9 428.3C518.4 392.5 545 350 558.6 320C545 290 518.4 247.5 479.9 211.7C438.8 173.6 385.2 144 320 144zM127.4 176.6C174.5 132.8 239.2 96 320 96C400.8 96 465.5 132.8 512.6 176.6C559.4 220.1 590.7 272 605.6 307.7C608.9 315.6 608.9 324.4 605.6 332.3C590.7 368 559.4 420 512.6 463.4C465.5 507.1 400.8 544 320 544C239.2 544 174.5 507.2 127.4 463.4C80.6 419.9 49.3 368 34.4 332.3C31.1 324.4 31.1 315.6 34.4 307.7C49.3 272 80.6 220 127.4 176.6zM320 400C364.2 400 400 364.2 400 320C400 290.4 383.9 264.5 360 250.7C358.6 310.4 310.4 358.6 250.7 360C264.5 383.9 290.4 400 320 400zM240.4 311.6C242.9 311.9 245.4 312 248 312C283.3 312 312 283.3 312 248C312 245.4 311.8 242.9 311.6 240.4C274.2 244.3 244.4 274.1 240.5 311.5zM286 196.6C296.8 193.6 308.2 192.1 319.9 192.1C328.7 192.1 337.4 193 345.7 194.7C346 194.8 346.2 194.8 346.5 194.9C404.4 207.1 447.9 258.6 447.9 320.1C447.9 390.8 390.6 448.1 319.9 448.1C258.3 448.1 206.9 404.6 194.7 346.7C192.9 338.1 191.9 329.2 191.9 320.1C191.9 309.1 193.3 298.3 195.9 288.1C196.1 287.4 196.2 286.8 196.4 286.2C208.3 242.8 242.5 208.6 285.9 196.7z"/>
                           </svg>
                        </div>
                   </div>
                </div>
            </div>
        </div>
        <script type="module">
            import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

            // Globals
            let simulatednodes = [
                {
                    id: "cf0b19f251f438",
                    title: "Idea 1",
                    color: 0,
                    content: "Lorem",
                    time: Date.now(),
                }, // Math.random().toString(16).slice(2)
                {
                    id: "1c0e0c501d58f8",
                    title: "Idea 2",
                    color: 0,
                    content: "Ipsum",
                    time: Date.now(),
                },
            ];
            let simulatedlinks = [
                { source: "cf0b19f251f438", target: "1c0e0c501d58f8", strength: 1 },
            ];

            let primarynodeid = "cf0b19f251f438";
            let secondarynodeid = "1c0e0c501d58f8";

            const dimensionscale = 0.5;

            const chartwidth = graphview.offsetWidth;
            const chartheight = graphview.offsetHeight;

            const simulation = d3
                .forceSimulation(simulatednodes)
                .force(
                    "link",
                    d3
                        .forceLink(simulatedlinks)
                        .id((link) => link.id)
                        .strength((link) => 1),
                )
                .force("charge", d3.forceManyBody())
                .force("x", d3.forceX().strength(0.01))
                .force("y", d3.forceY().strength(0.01));

            let zoomtransform = null;

            const svg = d3
                .create("svg")
                .attr("width", chartwidth)
                .attr("height", chartheight)
                .attr("viewBox", [
                    (-chartwidth / 2) * dimensionscale,
                    (-chartheight / 2) * dimensionscale,
                    chartwidth * dimensionscale,
                    chartheight * dimensionscale,
                ])
                .attr("style", "max-width: 100%; height: auto;")
                .call(
                    d3
                        .zoom()
                        .extent([
                            [0, 0],
                            [chartwidth, chartheight],
                        ])
                        .scaleExtent([0.2, 8])
                        .on("zoom", ({ transform }) => {
                            zoomtransform = transform;
                            graphlinks.attr("transform", transform);
                            graphnodes.attr("transform", transform);
                        }),
                );

            let graphlinks = svg
                .append("g")
                .selectAll("line")
                .data(simulatedlinks)
                .join("line");

            let graphnodes = svg
                .append("g")
                .selectAll("circle")
                .data(simulatednodes, (node) => node.id)
                .join("circle");

            simulation.on("tick", () => {
                graphlinks
                    .attr("x1", (link) => link.source.x)
                    .attr("y1", (link) => link.source.y)
                    .attr("x2", (link) => link.target.x)
                    .attr("y2", (link) => link.target.y)
                if (zoomtransform)
                  graphlinks.attr("transform", zoomtransform);

                graphnodes
                    .attr("cx", (node) => node.x)
                    .attr("cy", (node) => node.y)

                if (zoomtransform)
                  graphnodes.attr("transform", zoomtransform);
            });

            function updatenodestructure(nodes, links) { //should be called updategraphstructure
                simulation.nodes(nodes);
                simulation.force("link").links(links).strength((link)=>link.strength);
                simulation.alpha(1).restart();

                graphnodes = graphnodes
                    .data(nodes, (node) => node.id)
                    .join((enter) => enter.append("circle"));

                graphlinks = graphlinks
                    .data(
                        links,
                        (link) => `${link.source.id}\t${link.target.id}`,
                    )
                    .join("line");
            }

            function nodestructureupdated() {
                graphnodes.call(
                    d3
                        .drag()
                        .on("start", (event) => {
                            if (!event.active)
                                simulation.alphaTarget(0.3).restart();
                            event.subject.fx = event.subject.x;
                            event.subject.fy = event.subject.y;
                        })
                        .on("drag", (event) => {
                            event.subject.fx = event.x;
                            event.subject.fy = event.y;
                        })
                        .on("end", (event) => {
                            if (!event.active) simulation.alphaTarget(0);
                            event.subject.fx = null;
                            event.subject.fy = null;
                        }),
                ).on("click", nodeclicked);
            }

            function nodeclicked(event) {
              primarynodeid = event.target.__data__.id;
              secondarynodeid = getnextneighborid();
              selectionupdated();
              nodestylingupdated();
            }

            function filternodefortext(node, text) {
              return node.content.includes(text) || node.title.includes(text);
            }

            function searchbarupdated(event) {
              updateresults();
              if (graphfiltered)
                nodestylingupdated();
            }
            navsearchbar.addEventListener('input', searchbarupdated);

            let graphfiltered = false;
            function filtertoggled() {
              graphfiltered = !graphfiltered;
              if (graphfiltered) {
                graphfiltertoggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#96a0a1" d="M73 39.1C63.6 29.7 48.4 29.7 39.1 39.1C29.8 48.5 29.7 63.7 39 73.1L567 601.1C576.4 610.5 591.6 610.5 600.9 601.1C610.2 591.7 610.3 576.5 600.9 567.2L504.5 470.8C507.2 468.4 509.9 466 512.5 463.6C559.3 420.1 590.6 368.2 605.5 332.5C608.8 324.6 608.8 315.8 605.5 307.9C590.6 272.2 559.3 220.2 512.5 176.8C465.4 133.1 400.7 96.2 319.9 96.2C263.1 96.2 214.3 114.4 173.9 140.4L73 39.1zM208.9 175.1C241 156.2 278.1 144 320 144C385.2 144 438.8 173.6 479.9 211.7C518.4 247.4 545 290 558.5 320C544.9 350 518.3 392.5 479.9 428.3C476.8 431.1 473.7 433.9 470.5 436.7L425.8 392C439.8 371.5 448 346.7 448 320C448 249.3 390.7 192 320 192C293.3 192 268.5 200.2 248 214.2L208.9 175.1zM390.9 357.1L282.9 249.1C294 243.3 306.6 240 320 240C364.2 240 400 275.8 400 320C400 333.4 396.7 346 390.9 357.1zM135.4 237.2L101.4 203.2C68.8 240 46.4 279 34.5 307.7C31.2 315.6 31.2 324.4 34.5 332.3C49.4 368 80.7 420 127.5 463.4C174.6 507.1 239.3 544 320.1 544C357.4 544 391.3 536.1 421.6 523.4L384.2 486C364.2 492.4 342.8 496 320 496C254.8 496 201.2 466.4 160.1 428.3C121.6 392.6 95 350 81.5 320C91.9 296.9 110.1 266.4 135.5 237.2z"/></svg>'
              } else {
                graphfiltertoggle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#96a0a1" d="M320 144C254.8 144 201.2 173.6 160.1 211.7C121.6 247.5 95 290 81.4 320C95 350 121.6 392.5 160.1 428.3C201.2 466.4 254.8 496 320 496C385.2 496 438.8 466.4 479.9 428.3C518.4 392.5 545 350 558.6 320C545 290 518.4 247.5 479.9 211.7C438.8 173.6 385.2 144 320 144zM127.4 176.6C174.5 132.8 239.2 96 320 96C400.8 96 465.5 132.8 512.6 176.6C559.4 220.1 590.7 272 605.6 307.7C608.9 315.6 608.9 324.4 605.6 332.3C590.7 368 559.4 420 512.6 463.4C465.5 507.1 400.8 544 320 544C239.2 544 174.5 507.2 127.4 463.4C80.6 419.9 49.3 368 34.4 332.3C31.1 324.4 31.1 315.6 34.4 307.7C49.3 272 80.6 220 127.4 176.6zM320 400C364.2 400 400 364.2 400 320C400 290.4 383.9 264.5 360 250.7C358.6 310.4 310.4 358.6 250.7 360C264.5 383.9 290.4 400 320 400zM240.4 311.6C242.9 311.9 245.4 312 248 312C283.3 312 312 283.3 312 248C312 245.4 311.8 242.9 311.6 240.4C274.2 244.3 244.4 274.1 240.5 311.5zM286 196.6C296.8 193.6 308.2 192.1 319.9 192.1C328.7 192.1 337.4 193 345.7 194.7C346 194.8 346.2 194.8 346.5 194.9C404.4 207.1 447.9 258.6 447.9 320.1C447.9 390.8 390.6 448.1 319.9 448.1C258.3 448.1 206.9 404.6 194.7 346.7C192.9 338.1 191.9 329.2 191.9 320.1C191.9 309.1 193.3 298.3 195.9 288.1C196.1 287.4 196.2 286.8 196.4 286.2C208.3 242.8 242.5 208.6 285.9 196.7z"/></svg>'
              }
              nodestylingupdated();
            }
            graphfiltertoggle.addEventListener('click', filtertoggled);

            function trashnode(event) {
              let confirmation = window.prompt("Enter 'yes' to confirm deletion");
              if (confirmation != 'yes')
                return
              let graphnodedata = graphnodes.data();
              if (graphnodedata.length == 1) {
                alert("Can't delete last node");
                return
              }
              graphnodedata = graphnodedata.filter((node) => node.id != primarynodeid);
              updatenodestructure(graphnodedata, graphlinks.data().filter((link)=>!islinkwithprimary(link)));
              primarynodeid = secondarynodeid;
              secondarynodeid = getnextneighborid();
              selectionupdated();
              nodestylingupdated();
              nodestructureupdated();
            }
            editortrash.addEventListener('click', trashnode);

            function cyclecolor(nodeid=primarynodeid) {
              let targetnode = graphnodes.data().filter((node)=>node.id==nodeid)[0]
              targetnode.color = (targetnode.color + 1) % nodecolorscale.length;
              nodestylingupdated();
              updateresults();
              if (nodeid==primarynodeid)
                editordot.style.backgroundColor = nodecolorscale[targetnode.color];
            }
            editordot.addEventListener('click', ()=>{cyclecolor()})

            editorlinkadd.addEventListener('click', creategraphlink)
            function creategraphlink() {
              let targettitle = window.prompt("Enter target node title: ");
              let selectednodes = graphnodes
                  .data()
                  .filter((node) => node.title == targettitle);
              if (selectednodes.length == 0) {
                alert("Unmatched title");
                return;
              }
              let oldlinksdata = graphlinks.data();
              oldlinksdata.push({
                  source: primarynodeid,
                  target: selectednodes[0].id,
                  strength: 1,
              });

              secondarynodeid = selectednodes[0].id;
              updatenodestructure(graphnodes.data(), oldlinksdata);
              selectionupdated();
              nodestylingupdated();
            }

            function nodestrokecolor(node) {
                return node.id == primarynodeid ? "#64625D" : "#fcf6e5";
            }

            const nodecolorscale = ["#4689cc", "#8d9b31", "#cb4239", "#4E9A93", "#C24480", "#AE8B2D"];

            function nodestrokeopacity(node) {
                return node.id == primarynodeid ? 1 : 1;
            }

            function nodeopacity(node) {
              return !graphfiltered ? 1 : (filternodefortext(node, navsearchbar.textContent) ? 1 : 0.5);
            }

            function isselectedlink(link, id1=primarynodeid, id2=secondarynodeid) {
                return (
                    (id1 == link.source.id &&
                        id2 == link.target.id) ||
                    (id1 == link.target.id &&
                        id2 == link.source.id)
                );
            }

            function islinkwithprimary(link) {
                return (
                    primarynodeid == link.source.id ||
                    primarynodeid == link.target.id
                );
            }

            function linkcolor(link) {
                return isselectedlink(link) ? "#000" : "#999";
            }

            function linkstrokewidth(link) {
                return islinkwithprimary(link) ? 2 : 1;
            }

            function nodestylingupdated() {
                graphnodes
                    .attr("r", 5)
                    .attr("stroke", (node) => nodestrokecolor(node))
                    .attr("stroke-opacity", (node) => nodestrokeopacity(node))
                    .attr("stroke-width", 1.5)
                    .attr("fill", (node) => nodecolorscale[node.color])
                    .attr('fill-opacity', (node)=>nodeopacity(node));
                graphlinks
                    .attr("stroke", (link) => linkcolor(link))
                    .attr("stroke-opacity", 0.6)
                    .attr("stroke-width", (link) => linkstrokewidth(link));
            }

            function getneighbors(nodeid, targetonly=false) {
                return graphlinks.data().reduce((neighbors, link) => {
                    if (link.target.id === nodeid) {
                        neighbors.push(link.source.id);
                    } else if (link.source.id === nodeid && !targetonly) {
                        neighbors.push(link.target.id);
                    }
                    return neighbors;
                }, []);
            }

            function getnextneighborid(
                step = 1,
                targetnodeid = primarynodeid,
                targetneighborid = secondarynodeid,
            ) {
                const neighbornodeids = getneighbors(targetnodeid);
                if (neighbornodeids.length == 0) {
                    alert("Neighbor search returned empty.");
                }
                const index = neighbornodeids.indexOf(targetneighborid);
                if (index == -1) {
                    return neighbornodeids[0];
                } else {
                    return neighbornodeids[
                        (index + step + neighbornodeids.length) %
                            neighbornodeids.length
                    ];
                }
            }

            function updateresults(nodes=graphnodes.data().filter((node)=>filternodefortext(node, navsearchbar.textContent))) {
              navresults.innerHTML = "";
              let neighbornodeids = getneighbors(primarynodeid);
              let childnodeids = getneighbors(primarynodeid, true);

              for (let i = 0; i < nodes.length; i++) {
                let elem = document.createElement('tr');
                elem.addEventListener('click', ()=>{
                  primarynodeid = nodes[i].id;
                  secondarynodeid = getnextneighborid();
                  selectionupdated();
                  nodestylingupdated();
                });
                let temp1 = document.createElement('td');
                temp1.classList.add('resultdot');
                let temp2 = document.createElement('span');
                temp2.classList.add('dot');
                temp2.style.backgroundColor = nodecolorscale[nodes[i].color];
                temp2.addEventListener('click', ()=>{cyclecolor(nodes[i].id)})
                temp1.appendChild(temp2);
                elem.appendChild(temp1);
                temp1 = document.createElement('td');
                temp1.classList.add('resulttitle');
                temp1.innerText = nodes[i].title;
                elem.appendChild(temp1);
                temp1 = document.createElement('td');
                temp1.classList.add('resultdate');
                let time = new Date(nodes[i].time);
                temp1.innerText = time.getFullYear() + '/' + (parseInt(time.getMonth())+1) + '/' + time.getDate();
                elem.appendChild(temp1);
                temp1 = document.createElement('td');
                temp1.classList.add('resultlink');
                temp1.innerHTML = '<svg width="19px" height="19px" class="linkicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M451.5 160C434.9 160 418.8 164.5 404.7 172.7C388.9 156.7 370.5 143.3 350.2 133.2C378.4 109.2 414.3 96 451.5 96C537.9 96 608 166 608 252.5C608 294 591.5 333.8 562.2 363.1L491.1 434.2C461.8 463.5 422 480 380.5 480C294.1 480 224 410 224 323.5C224 322 224 320.5 224.1 319C224.6 301.3 239.3 287.4 257 287.9C274.7 288.4 288.6 303.1 288.1 320.8C288.1 321.7 288.1 322.6 288.1 323.4C288.1 374.5 329.5 415.9 380.6 415.9C405.1 415.9 428.6 406.2 446 388.8L517.1 317.7C534.4 300.4 544.2 276.8 544.2 252.3C544.2 201.2 502.8 159.8 451.7 159.8zM307.2 237.3C305.3 236.5 303.4 235.4 301.7 234.2C289.1 227.7 274.7 224 259.6 224C235.1 224 211.6 233.7 194.2 251.1L123.1 322.2C105.8 339.5 96 363.1 96 387.6C96 438.7 137.4 480.1 188.5 480.1C205 480.1 221.1 475.7 235.2 467.5C251 483.5 269.4 496.9 289.8 507C261.6 530.9 225.8 544.2 188.5 544.2C102.1 544.2 32 474.2 32 387.7C32 346.2 48.5 306.4 77.8 277.1L148.9 206C178.2 176.7 218 160.2 259.5 160.2C346.1 160.2 416 230.8 416 317.1C416 318.4 416 319.7 416 321C415.6 338.7 400.9 352.6 383.2 352.2C365.5 351.8 351.6 337.1 352 319.4C352 318.6 352 317.9 352 317.1C352 283.4 334 253.8 307.2 237.5z"/></svg>'
                temp1.addEventListener('click', ()=>{navlinkclicked(nodes[i].id)});
                temp1.dataset.nodeid = nodes[i].id;
                // change color based on link
                if (nodes[i].id == primarynodeid) {
                  elem.classList.add('selected');
                } else {
                  if (nodes[i].id == secondarynodeid)
                    elem.classList.add('secondary');
                  if (childnodeids.includes(nodes[i].id))
                    temp1.classList.add('rlsource');
                  else if (neighbornodeids.includes(nodes[i].id))
                    temp1.classList.add('rltarget');
                }
                elem.appendChild(temp1);
                navresults.appendChild(elem);
              }
            }

            function navlinkclicked(nodeid) {
              if (getneighbors(primarynodeid).includes(nodeid)) {
                let oldlinksdata = graphlinks.data();
                updatenodestructure(graphnodes.data(), oldlinksdata.filter((link)=>!isselectedlink(link, primarynodeid, nodeid)));
              } else {
                let oldlinksdata = graphlinks.data();
                oldlinksdata.push({
                    source: primarynodeid,
                    target: nodeid,
                    strength: 1,
                });
                updatenodestructure(graphnodes.data(), oldlinksdata);
                nodestylingupdated();
              }
              updateresults();
            }

            function selectionupdated() {
                let selectednodedata = graphnodes
                    .data()
                    .filter((nodedata) => nodedata.id === primarynodeid)[0];

                // <span class="editorlinkcycle">↑</span><span class="editorlinkdelete">&#x2715;</span>

                editorlinkbox.innerHTML = "";
                let neighborids = getneighbors(primarynodeid);
                let childids = getneighbors(primarynodeid, true);
                for (let i = 0; i < neighborids.length; i++) {
                  let neighbornode = graphnodes
                      .data()
                      .filter((nodedata) => nodedata.id === neighborids[i])[0];
                  let elem = document.createElement('div');
                  elem.classList.add('editorlink');
                  elem.innerText = neighbornode.title;
                  elem.dataset.linktargetid = neighbornode.id;
                  if (childids.includes(neighborids[i])) {
                    elem.dataset.relation = 'vis';
                  } else {
                    elem.dataset.relation = 'sim';
                  }
                  let span1 = document.createElement('span');
                  span1.classList.add('editorlinkcycle');
                  span1.addEventListener("click", cyclelink);
                  span1.innerText = '↑';
                  let span2 = document.createElement('span');
                  span2.classList.add('editorlinkdelete');
                  span2.innerHTML = '&#x2715;';
                  span2.addEventListener("click", deletelink);
                  elem.appendChild(span1);
                  elem.appendChild(span2);
                  editorlinkbox.appendChild(elem);
                }
                formatteditorcontent(selectednodedata.content);
                editordot.style.backgroundColor = nodecolorscale[selectednodedata.color];
                editortitle.textContent = selectednodedata.title;

                updateresults();
            }

            function deletelink(event) {
              let targeteditorlink = event.target.parentElement;
              let linktargetid = targeteditorlink.dataset.linktargetid;
              let oldlinksdata = graphlinks.data();
              updatenodestructure(graphnodes.data(), oldlinksdata.filter((link)=>!isselectedlink(link, primarynodeid, linktargetid)));
              targeteditorlink.remove();
            }

            function cyclelink(event) {
              let targeteditorlink = event.target.parentElement;
              let linktargetid = targeteditorlink.dataset.linktargetid;
              let oldlinksdata = graphlinks.data();
              let targetgraphlink = oldlinksdata.filter((link)=>isselectedlink(link, primarynodeid, linktargetid))[0];
              targetgraphlink.strength = -(targetgraphlink.strength - 1);
              updatenodestructure(graphnodes.data(), oldlinksdata);
            }

            function formatteditorcontent(inputcontent) {
              editorcontent.innerHTML = inputcontent;
            }

            function getcursorposition(parent, node, offset, stat) {
                if (stat.done) return stat;

                let currentNode = null;
                if (parent.childNodes.length == 0) {
                    stat.pos += parent.textContent.length;
                } else {
                    for (
                        let i = 0;
                        i < parent.childNodes.length && !stat.done;
                        i++
                    ) {
                        currentNode = parent.childNodes[i];
                        if (currentNode === node) {
                            stat.pos += offset;
                            stat.done = true;
                            return stat;
                        } else
                            getCursorPosition(currentNode, node, offset, stat);
                    }
                }
                return stat;
            }

            function setcursorposition(parent, range, stat) {
                if (stat.done) return range;

                if (parent.childNodes.length == 0) {
                    if (parent.textContent.length >= stat.pos) {
                        range.setStart(parent, stat.pos);
                        stat.done = true;
                    } else {
                        stat.pos = stat.pos - parent.textContent.length;
                    }
                } else {
                    for (
                        let i = 0;
                        i < parent.childNodes.length && !stat.done;
                        i++
                    ) {
                        setCursorPosition(parent.childNodes[i], range, stat);
                    }
                }
                return range;
            }

            editorcontent.addEventListener("input", (e) => {
                editorupdated(editortitle.textContent, e.target.innerHTML);
            });

            editortitle.addEventListener("input", (e) => {
                editorupdated(e.target.textContent, editorcontent.innerHTML);
            });

            function editorupdated(title, content) {
                let selectednodedata = graphnodes
                    .data()
                    .filter((nodedata) => nodedata.id === primarynodeid)[0];
                selectednodedata.content = content;
                selectednodedata.title = title;
            }

            // graphwalk
            addEventListener("keydown", (event) => {
                if (activeview == editorview) {
                  if (event.code == "Escape") {
                    event.preventDefault();
                    if (window.getSelection().empty) {  // Chrome
                        window.getSelection().empty();
                      } else if (window.getSelection().removeAllRanges) {  // Firefox
                        window.getSelection().removeAllRanges();
                    }
                    graphview.focus();
                    setactivegraphview();
                  }
                }
                if (activeview == navigatorview) {
                  if (event.code == "Escape") {
                    event.preventDefault();
                    if (window.getSelection().empty) {  // Chrome
                        window.getSelection().empty();
                      } else if (window.getSelection().removeAllRanges) {  // Firefox
                        window.getSelection().removeAllRanges();
                    }
                    graphview.focus();
                    setactivegraphview();
                  }
                }
                if (activeview == graphview) {
                    if (event.code == "KeyD") {
                        secondarynodeid = getnextneighborid();
                    } else if (event.code == "KeyA") {
                        secondarynodeid = getnextneighborid(-1);
                    } else if (event.code == "KeyW") {
                        primarynodeid = secondarynodeid;
                        secondarynodeid = getnextneighborid();
                    } else if (event.code == "KeyS") {
                        secondarynodeid = getnextneighborid(-1);

                        const temp = primarynodeid;
                        primarynodeid = secondarynodeid;
                        secondarynodeid = temp;
                    } else if (event.code == "KeyI") {
                        let newnodeid = Math.random().toString(16).slice(2);
                        let oldnodesdata = graphnodes.data();
                        oldnodesdata.push({
                            id: newnodeid,
                            title: newnodeid,
                            color: "0",
                            content: "",
                            time: Date.now(),
                        });
                        let oldlinksdata = graphlinks.data();
                        oldlinksdata.push({
                            source: primarynodeid,
                            target: newnodeid,
                            strength: 1,
                        });
                        secondarynodeid = primarynodeid;
                        primarynodeid = newnodeid;

                        updatenodestructure(oldnodesdata, oldlinksdata);
                        nodestructureupdated();
                    } else if (event.code == "KeyQ") {
                      let graphlinkdata = graphlinks.data();
                      graphlinkdata = graphlinkdata.map(({source, target, strength}) => {return {'source':source.id, 'target': target.id, 'strength': strength}});
                      download(JSON.stringify({graphnodedata: graphnodes.data(), graphlinkdata: graphlinkdata}), "nodetdata.json", "text/json");
                    } else if (event.code == "KeyL") {
                      creategraphlink();
                    } else if (event.code == "Space") {
                      event.preventDefault();
                      setactiveeditorview();
                      editortitle.focus();
                    } else {
                        return;
                    }
                    selectionupdated();
                    nodestylingupdated();
                }
            });

            addEventListener('beforeunload', (event) => {
                event.preventDefault();
                return confirm("Confirm refresh");
            });

            // Download & Upload
            function download(content, fileName, contentType) {
                var a = document.createElement("a");
                var file = new Blob([content], { type: contentType });
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
            }

            addEventListener("dragover", function (event) {
                event.preventDefault();
            });

            addEventListener("drop", (ev) => {
                ev.preventDefault();
                async function getDrop() {
                    const text = await [...ev.dataTransfer.items][0]
                        .getAsFile()
                        .text();
                    const { graphnodedata, graphlinkdata } = JSON.parse(text);
                    updatenodestructure(graphnodedata, graphlinkdata);
                    primarynodeid = graphnodes.data()[0].id;
                    secondarynodeid = getnextneighborid();
                    nodestructureupdated();
                    nodestylingupdated();
                }
                getDrop();
            });

            window.addEventListener("load", () => {
                ["click", "focusin"].forEach((event) => {
                    graphview.addEventListener(event, setactivegraphview);
                    editorview.addEventListener(event, setactiveeditorview);
                    navigatorview.addEventListener(
                        event,
                        setactivenavigatorview,
                    );
                });

                setactivegraphview();
            });

            function setactivegraphview() {
                graphview.style.backgroundColor = "var(--bglight)";

                editorview.style.backgroundColor = "var(--bgdark)";
                navigatorview.style.backgroundColor = "var(--bgdark)";

                activeview = graphview;
            }

            function setactiveeditorview() {
                editorview.style.backgroundColor = "var(--bglight)";

                navigatorview.style.backgroundColor = "var(--bgdark)";
                graphview.style.backgroundColor = "var(--bgdark)";

                activeview = editorview;
            }

            function setactivenavigatorview() {
                navigatorview.style.backgroundColor = "var(--bglight)";

                editorview.style.backgroundColor = "var(--bgdark)";
                graphview.style.backgroundColor = "var(--bgdark)";

                activeview = navigatorview;
            }

            let activeview = null;

            // finalize initial graph and add to view
            nodestructureupdated();
            nodestylingupdated();
            selectionupdated();
            updateresults(graphnodes.data());
            navsearchbar.textContent = "";
            graphview.append(svg.node());

            var loc = window.location.search.split('?p=');
            if (loc.length > 0) {
              var xhr = new XMLHttpRequest();
              xhr.open('GET', './notes/'+loc[1], true);
              xhr.responseType = 'json';
              xhr.onload = function() {
                var status = xhr.status;
                if (status === 200) {
                  console.log(xhr.response);
                  const { graphnodedata, graphlinkdata } = xhr.response;
                  updatenodestructure(graphnodedata, graphlinkdata);
                  primarynodeid = graphnodes.data()[0].id;
                  secondarynodeid = getnextneighborid();
                  nodestructureupdated();
                  nodestylingupdated();
                } else {
                  console.log(xhr.response);
                };
              }
              xhr.send();
            }
        </script>
    </body>
</html>
